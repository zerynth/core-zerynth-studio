<script>

var CreateVMModal = {
  dev: null,
  vms: null,
  patches: null,
  changelog: null,
  callback: null,
  exclusivity: false,
  __fill: function(data){
    console.log(data) 
    var vmdata = data.vms
    var patches = vmdata["patches"]
    if (patches.length<=0){
      CreateVMModal.vms=null
      return
    }
    CreateVMModal.exclusivity = false
    var vms = []

    vm_number = 0
    _.each(patches,(patch,idx,allvm)=>{
        var cnt=0
        _.each(vmdata.vms[patch],(v,k,l)=>{
          // basic_rtos = vmdata.rtoses[v.rtos].split(" ")[0].toLowerCase();
          license = v.pro ? ("premium"):("starter");
          xx = _.find(Store.profile.assets.table,(v2,k2,l2)=>{
            return k2==v.generic_rtos
          })
          yy = _.find(xx,(v2,k2,l2)=>{
            return k2==license
          })
          vm_exists = _.filter(data.my_vms.list,(v2,k2,l2)=>{
            return v2.rtos==v.rtos && v2.pro==v.pro
          })
          available = vm_exists.length > 0 ? (true) : (false);
          if (!available && yy) {
            available = yy.remaining ? (true) : (false);
          }
          vms.push({
            title:v.title,
            patch: patch,
            version: ZConf.vrs,
            description:v.description,
            rtos: vmdata.rtoses[v.rtos] || "None",
            features: _.map(v.features,(vv,kk,ll)=>{ return vmdata.features[vv]}).join(", ") || "---",
            thevm: v,
            pro:license,
            index:cnt,
            num:vm_number,
            available: available,
            exclusive: v.exclusive,
            exclusivity: v.exclusivity
          })
          if (v.exclusive || v.exclusivity) {
            CreateVMModal.exclusivity = v.exclusivity          
          }

          cnt++
          vm_number++
        })
    })
    if (data.dev.chipid){
      $("#create_vm_title").html("Create VM for "+data.dev.name+" ("+data.dev.chipid+")")
    } else {
      $("#create_vm_title").html("Create VM for "+data.dev.name+" (unknown id)")
    }

    //$("#createvm_modal_table").html($.templates("#createvm_modal_row").render({ patches:patches, changelog:vmdata.changelog,vms:vms}))

    var new_patches = _.map(patches,(elem)=>{
      var xx = {};
      xx.patch = elem;
      return xx
    })
    $("#createvm_modal_div").html("")
    CreateVMModal.dev = data.dev
    CreateVMModal.vms = vms
    CreateVMModal.patches = patches
    CreateVMModal.new_patches = new_patches
    CreateVMModal.changelog = vmdata["changelog"]
    CreateVMModal.callback = data.callback
    console.log(CreateVMModal)
    $("#createvm_modal").on("hidden.bs.modal", function () {
      if (CreateVMModal.callback) CreateVMModal.callback()
    });
    CreateVMModal.display_patch(new_patches[patches.length-1].patch)
  },
  __show: function(){
    if(!CreateVMModal.vms){
      Z.log("No available virtual machines for this device!")
      return
    }
    $("#createvm_modal").modal()
  },
  __hide: function(){
    $("#createvm_modal").modal("hide")
  },
  parse_accounts: function(msg) {
      var opos = msg.lastIndexOf("[")
      var cpos = msg.lastIndexOf("]")
      var accs = msg.substring(opos+1,cpos)
      var lastcomma = accs.lastIndexOf(",")
      if (lastcomma > 0) {
        accs = accs.substring(0,lastcomma) + " or "+ accs.substring(lastcomma+1)
      }
      return accs
  },
  run_create: function(vm,dev){
    var fn = (dev.manual) ? (ZTC.vmcreate_by_uid):(ZTC.vmcreate)
    fn(vm,dev)
      .then(()=>{
        CreateVMModal.__hide()
        Z.log("VM created! You can now virtualize your "+dev.target)
        ZDevices.disambiguate()
        App.upd_profile()
      })
      .catch((err)=>{
        Z.log(""+err)
        if (err.includes("ZE100")) {
            //TODO: parse err to extract required accounts
            accstring = CreateVMModal.parse_accounts(err)

            //hide everything
            $(".modal").modal("hide")
            //disable callback
            CreateVMModal.callback=null
            ZNotify.alert("This VM requires a "+accstring+" account! Please logout (Preferences => <a href=\"javascript:App.logout()\">Logout</a>) and sign-in with a "+accstring+" account.<br><br>If you don't have an account already, you can signup directly from the Zerynth Login page; remember to use your current email ["+Store.user_email()+"] in order to merge the accounts!","Exclusive VM","warning")
        } else {
            CreateVMModal.__hide()
        }
      })
  },
  display_patch: function(patch_name){
    var html=""
    var cc = CreateVMModal.changelog[patch_name]
    var vv = _.filter(CreateVMModal.vms,(item)=>{return item.patch==patch_name})
    var ordvms = []
    for (var rtos in ZConf.rtoses) {
      var listvm = _.filter(vv, (item)=>{
            return item.rtos==ZConf.rtoses[rtos]
          })
      if (listvm.length > 0){
        listvm = _.sortBy(listvm,"features")
        ordvms.push({"rtos":ZConf.rtoses[rtos],"vms":listvm})
      }
    }
    ordvms = _.sortBy(ordvms,"rtos").reverse()
    html=$.templates("#createvm_modal_table2").render({
        patch:patch_name,
        changelog:cc,
        vv:ordvms,
        patches:CreateVMModal.new_patches,
        exclusivity:CreateVMModal.exclusivity})
    $("#createvm_modal_div").html(html)
  },
  select: function(row){
    row.children('td').children('input').prop('checked', true);
    row.removeClass('selected');
    row.toggleClass('selected');
  },
  create: function(){
    var sel = $('#createvm_modal input[name="vms"]:checked').val()
    var vm = CreateVMModal.vms[sel]
    var dev = CreateVMModal.dev
    console.log(dev)
    console.log(sel)
    console.log(vm)
    Z.log("Creating VM for "+dev.target+"...")
    if (!dev.chipid){
        ZTC.command(["device","register",dev.alias])
        .then(()=>{
            CreateVMModal.run_create(vm,dev)
        })
        .catch((err)=>{
            CreateVMModal.__hide()
        })
    } else CreateVMModal.run_create(vm,dev)
  }
}

</script>
<script id="createvm_modal_table2" type="text/x-jsrender">
    <div style="font-size:15px;text-align: center">Create a Virtual Machine</div>
    <div style="font-size:15px;text-align: center">{{:patch.toUpperCase()}} RELEASE - Changelog: {{:changelog}}</div>
    <hr>
    {{if exclusivity}}
      <div style="font-size:15px;text-align:center;margin-bottom:6px"><span class="label label-primary">The VMs are available for {{:exclusivity}} users only</span></div>
    {{/if}}
    {{if patches.length>1}}
      <div style="font-size:15px;text-align: center" id="createvm_modal_ptch">Available patches:
        <br>
        <div id="patch_selector" class="btn-group" data-toggle="buttons">
          {{for patches ~cur=patch}}
            <label class="btn btn-{{if patch=='base'}}primary{{else}}warning{{/if}}">
              <input type="radio" name="patch_sel" id="input_{{:patch}}" value="{{:patch}}" onchange="CreateVMModal.display_patch('{{:patch}}')">{{:patch.toUpperCase()}}
            </label>
          {{/for}}  
        </div>
      </div>
    <hr>
    {{/if}}
    {{for vv ~cur=patch}}
      <p>Select one of the available configurations for {{:rtos}}</p>
      <table class="table table-striped table-bordered" style="max-height: 600px;padding:4px">
        <tr style="background-color:#468c8c;color:#ffffff">
          <th style="width:5%">#</th>
          <th style="width:30%">Configuration</th>
          <th style="width:15%">RTOS</th>
          <th style="width:30%">Features</th>
          <th style="width:10%">License</th>
          <th style="width:10%">Available</th>
        <tr>
        {{for vms ~pp=~cur}}
          <tr onclick="CreateVMModal.select($(this))">
            <td><input type="radio" value="{{:num}}" name="vms" {{if index==0}}checked{{/if}}></td>
            <td>{{:title}} ({{:~pp.toUpperCase()}})</td>
            <td>{{:rtos}}</td>
            <td>{{:features}}</td>
            <td>{{:pro[0].toUpperCase()+pro.substr(1)}}</td>
            <td style="text-align:center"><i class="glyphicon glyphicon-{{if available}}ok{{else}}remove{{/if}}" style="color:{{if available}}#3c763d{{else}}#a94442{{/if}}"></i></td>
          </tr>
        {{/for}}
      </table>
    {{/for}}
</script>
<style>
#createvm_modal_table td,
#createvm_modal_table th {
  vertical-align: middle;
}
</style>
<div class="modal fade" style="height:100%;overflow-y: auto;" id="createvm_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog" style="min-width: 70%;">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
          <span class="pficon pficon-close"></span>
        </button>
        <h4 class="modal-title" id="create_vm_title">Create VM</h4>
      </div>
      <div class="modal-body">
        <div id="createvm_modal_div"></div>
        <div class="alert alert-danger" style="display:none">
          <span class="pficon pficon-error-circle-o"></span><p id="createvm_error"></p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="CreateVMModal.create()">Create</button>
      </div>
    </div>
  </div>
</div>
