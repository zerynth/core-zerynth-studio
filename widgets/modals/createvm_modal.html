<script>

var CreateVMModal = {
  dev: null,
  vms: null,
  patches: null,
  changelog: null,
  callback: null,
  __fill: function(data){
    console.log(data) 
    var vmdata = data.vms
    var patches = vmdata["patches"]
    if (patches.length<=0){
      CreateVMModal.vms=null
      return
    }
    var vms = []

    vm_number = 0
    _.each(patches,(patch,idx,allvm)=>{
        var cnt=0
        _.each(vmdata.vms[patch],(v,k,l)=>{
          // basic_rtos = vmdata.rtoses[v.rtos].split(" ")[0].toLowerCase();
          license = v.pro ? ("premium"):("starter");
          xx = _.find(Store.profile.assets.table,(v2,k2,l2)=>{
            return k2==v.generic_rtos
          })
          yy = _.find(xx,(v2,k2,l2)=>{
            return k2==license
          })
          vm_exists = _.filter(data.my_vms.list,(v2,k2,l2)=>{
            return v2.rtos==v.rtos && v2.pro==v.pro
          })
          available = vm_exists.length > 0 ? (true) : (false);
          if (!available && yy) {
            available = yy.remaining ? (true) : (false);
          }
          vms.push({
            title:v.title,
            patch: patch,
            version: ZConf.vrs,
            description:v.description,
            rtos: vmdata.rtoses[v.rtos] || "None",
            features: _.map(v.features,(vv,kk,ll)=>{ return vmdata.features[vv]}).join(", ") || "---",
            thevm: v,
            pro:license,
            index:cnt,
            num:vm_number,
            available: available
          })
          cnt++
          vm_number++
        })
    })
    if (data.dev.chipid){
      $("#create_vm_title").html("Create VM for "+data.dev.name+" ("+data.dev.chipid+")")
    } else {
      $("#create_vm_title").html("Create VM for "+data.dev.name+" (unknown id)")
    }

    
    //$("#createvm_modal_table").html($.templates("#createvm_modal_row").render({ patches:patches, changelog:vmdata.changelog,vms:vms}))

    var new_patches = _.map(patches,(elem)=>{
      var xx = {};
      xx.patch = elem;
      return xx
    })
    $("#createvm_modal_div").html("")
    CreateVMModal.dev = data.dev
    CreateVMModal.vms = vms
    CreateVMModal.patches = patches
    CreateVMModal.new_patches = new_patches
    CreateVMModal.changelog = vmdata["changelog"]
    CreateVMModal.callback = data.callback
    console.log(CreateVMModal)
    $("#createvm_modal").on("hidden.bs.modal", function () {
      if (CreateVMModal.callback) CreateVMModal.callback()
    });
    CreateVMModal.display_patch(new_patches[patches.length-1].patch)
  },
  __show: function(){
    if(!CreateVMModal.vms){
      Z.log("No available virtual machines for this device!")
      return
    }
    $("#createvm_modal").modal()
  },
  __hide: function(){
    $("#createvm_modal").modal("hide")
  },
  run_create: function(vm,dev){
    ZTC.vmcreate(vm,dev)
      .then(()=>{
        CreateVMModal.__hide()
        Z.log("VM created! You can now virtualize your "+dev.target)
        ZDevices.disambiguate()
        App.upd_profile()
      })
      .catch((err)=>{
        CreateVMModal.__hide()
      })
  },
  display_patch: function(patch_name){
    var html=""
    var cc = CreateVMModal.changelog[patch_name]
    var vv = _.filter(CreateVMModal.vms,(item)=>{return item.patch==patch_name})
    html=$.templates("#createvm_modal_table2").render({patch:patch_name,changelog:cc,vms:vv,patches:CreateVMModal.new_patches})
    $("#createvm_modal_div").html(html)
  },
  select: function(row){
    row.children('td').children('input').prop('checked', true);
    row.removeClass('selected');
    row.toggleClass('selected');
  },
  create: function(){
    var sel = $('#createvm_modal input[name="vms"]:checked').val()
    var vm = CreateVMModal.vms[sel]
    var dev = CreateVMModal.dev
    Z.log("Creating VM for "+dev.target+"...")
    if (!dev.chipid){
        ZTC.command(["device","register",dev.alias])
        .then(()=>{
            CreateVMModal.run_create(vm,dev)
        })
        .catch((err)=>{
            CreateVMModal.__hide()
        })
    } else CreateVMModal.run_create(vm,dev)
  }
}

</script>
<script id="createvm_modal_table2" type="text/x-jsrender">
    <div style="font-size:15px;text-align: center">Create a Virtual Machine</div>
    <div style="font-size:15px;text-align: center">{{:patch.toUpperCase()}} RELEASE - Changelog: {{:changelog}}</div>
    <hr>
    {{if patches.length>1}}
      <div style="font-size:15px;text-align: center" id="createvm_modal_ptch">Available patches:
        <br>
        <div id="patch_selector" class="btn-group" data-toggle="buttons">
          {{for patches ~cur=patch}}
            <label class="btn btn-{{if patch=='base'}}primary{{else}}warning{{/if}}">
              <input type="radio" name="patch_sel" id="input_{{:patch}}" value="{{:patch}}" onchange="CreateVMModal.display_patch('{{:patch}}')">{{:patch.toUpperCase()}}
            </label>
          {{/for}}  
        </div>
      </div>
    <hr>
    {{/if}}
    <p>Select one of the available configurations</p>
    <table class="table table-striped table-bordered" style="max-height: 600px;padding:4px">
    <tr style="background-color:#468c8c;color:#ffffff"><th style="width:5%">#</th><th style="width:30%">Configuration</th><th style="width:15%">RTOS</th><th style="width:30%">Features</th><th style="width:10%">License</th><th style="width:10%">Available</th><tr>
    {{for vms ~cur=patch}}
            <tr onclick="CreateVMModal.select($(this))">
              <td><input type="radio" value="{{:num}}" name="vms" {{if index==0}}checked{{/if}}></td>
              <td>{{:title}} ({{:~cur.toUpperCase()}})</td>
              <td>{{:rtos}}</td>
              <td>{{:features}}</td>
              <td>{{:pro[0].toUpperCase()+pro.substr(1)}}</td>
              <td style="text-align:center"><i class="glyphicon glyphicon-{{if available}}ok{{else}}remove{{/if}}" style="color:{{if available}}#3c763d{{else}}#a94442{{/if}}"></i></td>
            </tr>
    {{/for}}
    </table>
</script>
<style>
#createvm_modal_table td,
#createvm_modal_table th {
  vertical-align: middle;
}
</style>
<div class="modal fade" style="height:100%;overflow-y: auto;" id="createvm_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog" style="min-width: 70%;">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
          <span class="pficon pficon-close"></span>
        </button>
        <h4 class="modal-title" id="create_vm_title">Create VM</h4>
      </div>
      <div class="modal-body">
        <div id="createvm_modal_div"></div>
        <div class="alert alert-danger" style="display:none">
          <span class="pficon pficon-error-circle-o"></span><p id="createvm_error"></p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="CreateVMModal.create()">Create</button>
      </div>
    </div>
  </div>
</div>
